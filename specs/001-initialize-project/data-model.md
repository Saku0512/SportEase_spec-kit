# Data Model: SportEase

**Source**: `spec.md` Key Entities
**Database**: PostgreSQL

This document defines the database schema for the SportEase project. Each microservice will manage a subset of these tables.

---

### E-R Diagram (Conceptual)

```mermaid
erDiagram
    users {
        varchar(255) id PK
        varchar(255) google_id
        varchar(255) name
        varchar(255) email
        int role_id FK
        int class_id FK
        timestamp created_at
    }

    roles {
        int id PK
        varchar(50) name
    }

    classes {
        int id PK
        varchar(100) name
    }

    events {
        int id PK
        varchar(255) name
        text description
        timestamp start_time
        timestamp end_time
    }

    teams {
        int id PK
        varchar(255) name
        int class_id FK
    }

    matches {
        int id PK
        int event_id FK
        int team1_id FK
        int team2_id FK
        varchar(50) status
        timestamp start_time
    }

    event_registrations {
        int user_id FK
        int event_id FK
    }

    qr_codes {
        varchar(255) id PK
        int user_id FK
        int event_id FK
        timestamp expires_at
    }

    attendance_records {
        int id PK
        int user_id FK
        int event_id FK
        timestamp scanned_at
    }

    users ||--o{ roles : "has"
    users ||--o{ classes : "belongs to"
    teams ||--o{ classes : "is from"
    matches ||--o{ events : "is part of"
    matches ||--o{ teams : "team1"
    matches ||--o{ teams : "team2"
    event_registrations }|..|{ users : "registers for"
    event_registrations }|..|{ events : "registers for"
    qr_codes ||--o{ users : "generated by"
    qr_codes ||--o{ events : "for"
    attendance_records ||--o{ users : "attended by"
    attendance_records ||--o{ events : "for"

```

---

## Table Schemas

### `roles`
Stores user roles (e.g., 管理者, 学生).
- **Managed by**: User Service

| Column | Type | Constraints |
|---|---|---|
| `id` | `SERIAL` | **PRIMARY KEY** |
| `name` | `VARCHAR(50)` | **UNIQUE**, **NOT NULL** |

### `classes`
Stores student classes.
- **Managed by**: User Service

| Column | Type | Constraints |
|---|---|---|
| `id` | `SERIAL` | **PRIMARY KEY** |
| `name` | `VARCHAR(100)` | **UNIQUE**, **NOT NULL** |

### `users`
Core system users.
- **Managed by**: User Service

| Column | Type | Constraints |
|---|---|---|
| `id` | `UUID` | **PRIMARY KEY**, `DEFAULT gen_random_uuid()` |
| `google_id` | `VARCHAR(255)` | **UNIQUE**, **NOT NULL** |
| `name` | `VARCHAR(255)` | **NOT NULL** |
| `email` | `VARCHAR(255)` | **UNIQUE**, **NOT NULL** |
| `role_id` | `INTEGER` | **FOREIGN KEY** -> `roles(id)` |
| `class_id` | `INTEGER` | **FOREIGN KEY** -> `classes(id)`, NULLABLE |
| `created_at` | `TIMESTAMPTZ` | `DEFAULT NOW()` |
| `updated_at` | `TIMESTAMPTZ` | `DEFAULT NOW()` |

### `events`
Sports events.
- **Managed by**: Event Service

| Column | Type | Constraints |
|---|---|---|
| `id` | `SERIAL` | **PRIMARY KEY** |
| `name` | `VARCHAR(255)` | **NOT NULL** |
| `description` | `TEXT` | |
| `start_time` | `TIMESTAMPTZ` | **NOT NULL** |
| `end_time` | `TIMESTAMPTZ` | **NOT NULL** |

### `teams`
Teams participating in events, usually linked to a class.
- **Managed by**: Event Service

| Column | Type | Constraints |
|---|---|---|
| `id` | `SERIAL` | **PRIMARY KEY** |
| `name` | `VARCHAR(255)` | **NOT NULL** |
| `class_id` | `INTEGER` | **FOREIGN KEY** -> `classes(id)` |

### `matches`
Individual matches within an event.
- **Managed by**: Event Service

| Column | Type | Constraints |
|---|---|---|
| `id` | `SERIAL` | **PRIMARY KEY** |
| `event_id` | `INTEGER` | **FOREIGN KEY** -> `events(id)` |
| `round` | `INTEGER` | **NOT NULL** |
| `match_number_in_round` | `INTEGER` | **NOT NULL** |
| `team1_id` | `INTEGER` | **FOREIGN KEY** -> `teams(id)`, NULLABLE |
| `team2_id` | `INTEGER` | **FOREIGN KEY** -> `teams(id)`, NULLABLE |
| `winner_id` | `INTEGER` | **FOREIGN KEY** -> `teams(id)`, NULLABLE |
| `status` | `VARCHAR(50)` | `DEFAULT 'PENDING'` |
| `start_time` | `TIMESTAMPTZ` | NULLABLE |

### `event_registrations`
Join table for users registering for events.
- **Managed by**: Event Service

| Column | Type | Constraints |
|---|---|---|
| `user_id` | `UUID` | **PRIMARY KEY**, **FOREIGN KEY** -> `users(id)` |
| `event_id` | `INTEGER` | **PRIMARY KEY**, **FOREIGN KEY** -> `events(id)` |

### `qr_codes`
Stores temporary QR codes for event attendance.
- **Managed by**: QR Code Service

| Column | Type | Constraints |
|---|---|---|
| `id` | `UUID` | **PRIMARY KEY**, `DEFAULT gen_random_uuid()` |
| `user_id` | `UUID` | **FOREIGN KEY** -> `users(id)` |
| `event_id` | `INTEGER` | **FOREIGN KEY** -> `events(id)` |
| `expires_at` | `TIMESTAMPTZ` | **NOT NULL** |
| `created_at` | `TIMESTAMPTZ` | `DEFAULT NOW()` |

### `attendance_records`
Logs student attendance for events.
- **Managed by**: Attendance Service

| Column | Type | Constraints |
|---|---|---|
| `id` | `SERIAL` | **PRIMARY KEY** |
| `user_id` | `UUID` | **FOREIGN KEY** -> `users(id)` |
| `event_id` | `INTEGER` | **FOREIGN KEY** -> `events(id)` |
| `scanned_at` | `TIMESTAMPTZ` | `DEFAULT NOW()` |
